# Apache Log4j2 CVE-2021-44228 node agent

AWS has developed several [jars](https://github.com/corretto/hotpatch-for-apache-log4j2) that performs a JVM-level hot-patch which disables JNDI lookups from the Log4j2 library, mitigating [Log4j2 CVE-2021-44228](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228).

The Apache Log4j2 CVE-2021-44228 node agent is an open source project built by the Kubernetes team at AWS. It is designed to run as a DaemonSet and mitigate the impact of Log4j2 CVE-2021-44228, which affects applications running Apache Log4j2 versions < 2.15.0 when processing inputs from untrusted sources. Running this DeamonSet will patch JVMs running in containers as well as on the host.

**What it does:** A cron entry will be installed on every worker node that runs a process looking for running JVMs and injects an agent which mitigates the Log4J2 CVE. All JVMs, including those running in containers will be hot-patched in this way. Currently, the hot-patch process is configured to run every 30min with a 15min jitter. The effective window can range from 15 to 45min between runs.

**Note:** You can find additional information about the Log4j2 vulnerability and AWS response in the [IBM xforce](https://exchange.xforce.ibmcloud.com/collection/4daa3df4f73a51590efced7fb90bc949).

## Installation instructions
1. Apply the manifest:
```bash
kubectl apply -f daemonset.yaml
```

2. Check the logs for one or more of your DaemonSet pods.

Spot check a single pod:
```bash
kubectl get pods -l job=node-patch-installer -n node-configuration-daemonset
```
```bash
kubectl logs <pod-name> -c node-patch-installer -n node-configuration-daemonset
```

### Considerations

* This project is meant to act as a temporary, best effort mitigation until you can update the Log4j2 dependency in all of your Java based Kubernetes applications to at least Log4j version 2.15.0. Do not rely on this agent as a long-term mitigation. This tool may help you mitigate the risk when updating dependencies is not immediately possible.

* With the default runtime frequency of 30 mins, the agent is better suited for long-running containers.
* The RPM only works with the following Java distributions:
    * Credo
    * Corretto
    * OpenJDK

## About CVE-2021-44228

Apache Log4j2 < 2.15.0 JNDI features used in configuration, log messages, and parameters do not protect against attacker controlled LDAP and other JNDI related endpoints. An attacker who can control log messages or log message parameters can execute arbitrary code loaded from LDAP servers when message lookup substitution is enabled. From Log4j2 versions < 2.15.0, this behavior has been disabled by default. Full details can be found in the [CVE bulletin](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228).

You can find additional information about the Log4j2 vulnerability in the [IBM xforce](https://exchange.xforce.ibmcloud.com/collection/4daa3df4f73a51590efced7fb90bc949).


## How this works

It will performs a JVM-level hotpatch disabling JNDI lookups from the Log4j2 library, mitigating the Log4j2 issue for that applies to JVMs on the host as well as JVMs running in containers. This project packages up the script and jars as a Kubernetes DaemonSet.

When installed, a process will run on every worker node that looks for running JVMs and injects an agent into the JVM to mitigate the Log4j2 vulnerability. The agent attempts to patch the `lookup()` method of all loaded `org.apache.logging.log4j.core.lookup.JndiLookup` instances to unconditionally return the string `Patched JndiLookup::lookup()`. This is designed to address the [CVE-2021-44228](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228/) remote code execution vulnerability in Log4j2 without restarting the Java process.

This process by default is configured to run every 30 mins, and will add a layer of protection in clusters where applications have yet to be patched with an updated Log4j2 dependency.
